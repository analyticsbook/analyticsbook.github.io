<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="Out-of-bag error in random forests | Data Analytics" />
<meta property="og:type" content="book" />





<meta name="author" content="Shuai Huang &amp; Houtao Deng" />


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Out-of-bag error in random forests | Data Analytics">

<title>Out-of-bag error in random forests | Data Analytics</title>

<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<script src="https://use.typekit.net/ajy6rnl.js"></script>
<script>try{Typekit.load({ async: true });}catch(e){}</script>
<!-- <link rel="stylesheet" href="css/normalize.css"> -->
<!-- <link rel="stylesheet" href="css/envisioned.css"/> -->
<link rel="stylesheet" href="css/tablesaw-stackonly.css"/>
<link rel="stylesheet" href="css/nudge.css"/>
<link rel="stylesheet" href="css/sourcesans.css"/>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>




</head>

<body>

<!--bookdown:toc:start-->

<nav class="pushy pushy-left" id="TOC">
<ul>
<li><a href="#preface">Preface</a></li>
<li><a href="#acknowledgments">Acknowledgments</a></li>
<li><a href="#chapter-1.-introduction">Chapter 1. Introduction</a></li>
<li><a href="#chapter-2.-abstraction-regression-tree-models">Chapter 2. Abstraction: Regression &amp; Tree Models</a></li>
<li><a href="#chapter-3.-recognition-logistic-regression-ranking">Chapter 3. Recognition: Logistic Regression &amp; Ranking</a></li>
<li><a href="#chapter-4.-resonance-bootstrap-random-forests">Chapter 4. Resonance: Bootstrap &amp; Random Forests</a></li>
<li><a href="#chapter-5.-learning-i-cross-validation-oob">Chapter 5. Learning (I): Cross-validation &amp; OOB</a></li>
<li><a href="#chapter-6.-diagnosis-residuals-heterogeneity">Chapter 6. Diagnosis: Residuals &amp; Heterogeneity</a></li>
<li><a href="#chapter-7.-learning-ii-svm-ensemble-learning">Chapter 7. Learning (II): SVM &amp; Ensemble Learning</a></li>
<li><a href="#chapter-8.-scalability-lasso-pca">Chapter 8. Scalability: LASSO &amp; PCA</a></li>
<li><a href="#chapter-9.-pragmatism-experience-experimental">Chapter 9. Pragmatism: Experience &amp; Experimental</a></li>
<li><a href="#chapter-10.-synthesis-architecture-pipeline">Chapter 10. Synthesis: Architecture &amp; Pipeline</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#appendix-a-brief-review-of-background-knowledge">Appendix: A Brief Review of Background Knowledge</a></li>
</ul>
</nav>

<!--bookdown:toc:end-->

<div class="menu-btn"><h3>☰ Menu</h3></div>

<div class="site-overlay"></div>


<div class="row">
<div class="col-sm-12">

<nav class="pushy pushy-left" id="TOC">
<ul>
<li><a href="index.html#preface">Preface</a></li>
<li><a href="acknowledgments.html#acknowledgments">Acknowledgments</a></li>
<li><a href="chapter-1-introduction.html#chapter-1.-introduction">Chapter 1. Introduction</a></li>
<li><a href="chapter-2-abstraction-regression-tree-models.html#chapter-2.-abstraction-regression-tree-models">Chapter 2. Abstraction: Regression &amp; Tree Models</a></li>
<li><a href="chapter-3-recognition-logistic-regression-ranking.html#chapter-3.-recognition-logistic-regression-ranking">Chapter 3. Recognition: Logistic Regression &amp; Ranking</a></li>
<li><a href="chapter-4-resonance-bootstrap-random-forests.html#chapter-4.-resonance-bootstrap-random-forests">Chapter 4. Resonance: Bootstrap &amp; Random Forests</a></li>
<li><a href="chapter-5-learning-i-cross-validation-oob.html#chapter-5.-learning-i-cross-validation-oob">Chapter 5. Learning (I): Cross-validation &amp; OOB</a></li>
<li><a href="chapter-6-diagnosis-residuals-heterogeneity.html#chapter-6.-diagnosis-residuals-heterogeneity">Chapter 6. Diagnosis: Residuals &amp; Heterogeneity</a></li>
<li><a href="chapter-7-learning-ii-svm-ensemble-learning.html#chapter-7.-learning-ii-svm-ensemble-learning">Chapter 7. Learning (II): SVM &amp; Ensemble Learning</a></li>
<li><a href="chapter-8-scalability-lasso-pca.html#chapter-8.-scalability-lasso-pca">Chapter 8. Scalability: LASSO &amp; PCA</a></li>
<li><a href="chapter-9-pragmatism-experience-experimental.html#chapter-9.-pragmatism-experience-experimental">Chapter 9. Pragmatism: Experience &amp; Experimental</a></li>
<li><a href="chapter-10-synthesis-architecture-pipeline.html#chapter-10.-synthesis-architecture-pipeline">Chapter 10. Synthesis: Architecture &amp; Pipeline</a></li>
<li><a href="conclusion.html#conclusion">Conclusion</a></li>
<li><a href="appendix-a-brief-review-of-background-knowledge.html#appendix-a-brief-review-of-background-knowledge">Appendix: A Brief Review of Background Knowledge</a></li>
</ul>
</nav>

</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="out-of-bag-error-in-random-forests" class="section level2 unnumbered">
<h2>Out-of-bag error in random forests</h2>
<p>The random forest model provides a concept named out-of-bag error that plays a similar role as the hold-out method. Let’s revisit how it works.</p>
<div id="rationale-and-formulation-8" class="section level3 unnumbered">
<h3>Rationale and formulation</h3>
<p>Suppose that we have a training dataset of <span class="math inline">\(5\)</span> instances (IDs as <span class="math inline">\(1,2,3,4,5\)</span>). A random forest model with <span class="math inline">\(3\)</span> trees is built. The <span class="math inline">\(3\)</span> Bootstrapped datasets are shown in Table <a href="out-of-bag-error-in-random-forests.html#tab:t5-2">16</a>.</p>
<p></p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:t5-2">Table 16: </span>Three trees and the bootstrapped datasets</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left"><em>Tree</em></th>
<th align="left">Bootstrap</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(1\)</span></td>
<td align="left"><span class="math inline">\(1,1,4,4,5\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left"><span class="math inline">\(2,3,3,4,4\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(3\)</span></td>
<td align="left"><span class="math inline">\(1,2,2,5,5\)</span></td>
</tr>
</tbody>
</table>
<p></p>
<p>Since Bootstrap <em>randomly</em> selects samples from the original dataset to form Bootstrapped datasets, some data points in the original dataset may not show up in the Bootstrapped datasets. These data points are called <strong>out-of-bag samples</strong> (<strong>OOB</strong>) samples . For instance, for the random forest model that corresponds to Table <a href="out-of-bag-error-in-random-forests.html#tab:t5-2">16</a>, the OOB samples for each tree are shown in Table <a href="out-of-bag-error-in-random-forests.html#tab:t5-3">17</a>.</p>
<p></p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:t5-3">Table 17: </span>Out-of-bag (OOB) samples</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left"><em>Tree</em></th>
<th align="left">OOB samples</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(1\)</span></td>
<td align="left"><span class="math inline">\(2,3\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left"><span class="math inline">\(1,5\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(3\)</span></td>
<td align="left"><span class="math inline">\(3,4\)</span></td>
</tr>
</tbody>
</table>
<p></p>
<p>The data points that are not used in training a tree could be used to test the tree. The errors on the OOB samples are called the <strong>out-of-bag errors</strong> . The OOB error can be calculated after a random forest model has been built, which seems to be computationally easier than cross-validation. An example to compute the OOB errors is shown in Table <a href="out-of-bag-error-in-random-forests.html#tab:t5-OOB">18</a>.</p>
<p></p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:t5-OOB">Table 18: </span>Out-of-bag (OOB) errors</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">Data ID</th>
<th align="left">True label</th>
<th align="left"><em>Tree</em> <span class="math inline">\(1\)</span></th>
<th align="left"><em>Tree</em> <span class="math inline">\(2\)</span></th>
<th align="left"><em>Tree</em> <span class="math inline">\(3\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(1\)</span></td>
<td align="left"><span class="math inline">\(C1\)</span></td>
<td align="left"></td>
<td align="left"><span class="math inline">\(C1\)</span></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(2\)</span></td>
<td align="left"><span class="math inline">\(C2\)</span></td>
<td align="left"><span class="math inline">\(C1\)</span></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(3\)</span></td>
<td align="left"><span class="math inline">\(C2\)</span></td>
<td align="left"><span class="math inline">\(C2\)</span></td>
<td align="left"></td>
<td align="left"><span class="math inline">\(C2\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(4\)</span></td>
<td align="left"><span class="math inline">\(C1\)</span></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"><span class="math inline">\(C1\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(5\)</span></td>
<td align="left"><span class="math inline">\(C2\)</span></td>
<td align="left"></td>
<td align="left"><span class="math inline">\(C2\)</span></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p></p>
<p>We can see that, as the data instance (<em>ID</em> = <span class="math inline">\(1\)</span>) is not used in training <em>Tree</em> <span class="math inline">\(2\)</span>, we can use <em>Tree</em> <span class="math inline">\(2\)</span> to predict on this data instance, and we see that it correctly predicts the class as <span class="math inline">\(C1\)</span>. Similarly, <em>Tree</em> <span class="math inline">\(1\)</span> is used to predict on data instance (<em>ID</em> = <span class="math inline">\(2\)</span>), and the prediction is wrong. Overall, the OOB error of the random forest model is <span class="math inline">\(1/6\)</span>.</p>
</div>
<div id="theory-and-method-5" class="section level3 unnumbered">
<h3>Theory and method</h3>
<p>The OOB error provides a computationally convenient approach to evaluate the random forest model without using a testing dataset or a cross-validation procedure. A technical concern is whether this idea can scale up. In other words, are there enough OOB samples to ensure that the OOB error is a fair and robust performance metric?</p>
<p>Recall that, for a random forest model with <span class="math inline">\(K\)</span> trees, each tree is built on a Bootstrapped dataset from the original training dataset <span class="math inline">\(D\)</span>. There are totally <span class="math inline">\(K\)</span> Bootstrapped datasets, denoted as <span class="math inline">\(B_{1,} B_{2}, \ldots, B_{K}\)</span>.</p>
<p>Usually, the size of each Bootstrapped dataset is the same size (denoted as <span class="math inline">\(N\)</span>) as the training dataset <span class="math inline">\(D\)</span>. Each data point in the Bootstrapped dataset is randomly and <em>independently</em> selected. Therefore, the probability of a data point from the training dataset <span class="math inline">\(D\)</span> missing from a Bootstrapped dataset is<label for="tufte-sn-129" class="margin-toggle sidenote-number">129</label><input type="checkbox" id="tufte-sn-129" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">129</span> Because there are <span class="math inline">\(N\)</span> independent trials of random selection, for a data point not to be selected, it has to be missed <span class="math inline">\(N\)</span> times. And the probability for “not to be selected” is <span class="math inline">\(\left(1-\frac{1}{N}\right)\)</span>.</span></p>
<p><span class="math display">\[\left(1-\frac{1}{N}\right)^{N}.\]</span></p>
<p>When <span class="math inline">\(N\)</span> is sufficiently large, we have</p>
<p><span class="math display">\[\lim _{N \rightarrow \infty}\left(1-\frac{1}{N}\right)^{N}=e^{-1} \approx 0.37.\]</span></p>
<p>Therefore, roughly <span class="math inline">\(37\%\)</span> of the data points from <span class="math inline">\(D\)</span> are not contained in a Bootstrapped dataset <span class="math inline">\(B_i\)</span>, and thus, not used for training the <em>tree</em> <span class="math inline">\(i\)</span>. These excluded data points are the OOB samples for the <em>tree</em> <span class="math inline">\(i\)</span>.</p>
<p>As there are <span class="math inline">\(37\%\)</span> of probability that a data point is not used for training a tree, we can infer that, on average, a data point is not used for training about <span class="math inline">\(37\%\)</span> of the trees<label for="tufte-sn-130" class="margin-toggle sidenote-number">130</label><input type="checkbox" id="tufte-sn-130" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">130</span> Note that the assumption is the Bootstrapped dataset has the same size as the original dataset, and the sampling is with replacement.</span>. In other words, for each data point, in theory <span class="math inline">\(37\%\)</span> of the trees are trained without this data point. This is a sizeable amount of data points, ensuring that the OOB error could be a stable and accurate evaluation of the model’s performance on <em>future unseen testing data</em>.</p>
</div>
<div id="r-lab-7" class="section level3 unnumbered">
<h3>R Lab</h3>
<p>We design a numeric study to compare the OOB error with the error obtained by a validation procedure and the error estimated on the training dataset. The three types of error rates are plotted in Figure <a href="out-of-bag-error-in-random-forests.html#fig:f5-15">87</a>.</p>
<p></p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:f5-15"></span>
<img src="graphics/5_15.png" alt="Comparison of different types of error rates" width="250px"  />
<!--
<p class="caption marginnote">-->Figure 87: Comparison of different types of error rates<!--</p>-->
<!--</div>--></span>
</p>
<p></p>
<p>First, we split the dataset into two halves: one for training and one for testing.</p>
<p></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="out-of-bag-error-in-random-forests.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb118-2"><a href="out-of-bag-error-in-random-forests.html#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb118-3"><a href="out-of-bag-error-in-random-forests.html#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb118-4"><a href="out-of-bag-error-in-random-forests.html#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(randomForest)</span>
<span id="cb118-5"><a href="out-of-bag-error-in-random-forests.html#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb118-6"><a href="out-of-bag-error-in-random-forests.html#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="out-of-bag-error-in-random-forests.html#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RCurl)</span>
<span id="cb118-8"><a href="out-of-bag-error-in-random-forests.html#cb118-8" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;https://raw.githubusercontent.com&quot;</span>,</span>
<span id="cb118-9"><a href="out-of-bag-error-in-random-forests.html#cb118-9" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;/analyticsbook/book/main/data/AD.csv&quot;</span>)</span>
<span id="cb118-10"><a href="out-of-bag-error-in-random-forests.html#cb118-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">text =</span> <span class="fu">getURL</span>(url))</span>
<span id="cb118-11"><a href="out-of-bag-error-in-random-forests.html#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="out-of-bag-error-in-random-forests.html#cb118-12" aria-hidden="true" tabindex="-1"></a>target_indx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(data) <span class="sc">==</span> <span class="st">&quot;DX_bl&quot;</span>)</span>
<span id="cb118-13"><a href="out-of-bag-error-in-random-forests.html#cb118-13" aria-hidden="true" tabindex="-1"></a>data[, target_indx] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">paste0</span>(<span class="st">&quot;c&quot;</span>, data[, target_indx]))</span>
<span id="cb118-14"><a href="out-of-bag-error-in-random-forests.html#cb118-14" aria-hidden="true" tabindex="-1"></a>rm_indx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;TOTAL13&quot;</span>, <span class="st">&quot;MMSCORE&quot;</span>))</span>
<span id="cb118-15"><a href="out-of-bag-error-in-random-forests.html#cb118-15" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data[, <span class="sc">-</span>rm_indx]</span>
<span id="cb118-16"><a href="out-of-bag-error-in-random-forests.html#cb118-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-17"><a href="out-of-bag-error-in-random-forests.html#cb118-17" aria-hidden="true" tabindex="-1"></a>para.v <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>)</span>
<span id="cb118-18"><a href="out-of-bag-error-in-random-forests.html#cb118-18" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p></p>
<p>Then, we build a set of random forest models by tuning the parameter <code>nodesize</code>, and obtain the OOB errors of the models.</p>
<p></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="out-of-bag-error-in-random-forests.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OOB error</span></span>
<span id="cb119-2"><a href="out-of-bag-error-in-random-forests.html#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ipara <span class="cf">in</span> para.v) {</span>
<span id="cb119-3"><a href="out-of-bag-error-in-random-forests.html#cb119-3" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(DX_bl <span class="sc">~</span> ., <span class="at">nodesize =</span> ipara, <span class="at">data =</span> data) </span>
<span id="cb119-4"><a href="out-of-bag-error-in-random-forests.html#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co"># nodesize = inodesize</span></span>
<span id="cb119-5"><a href="out-of-bag-error-in-random-forests.html#cb119-5" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">c</span>(<span class="st">&quot;OOB_Error&quot;</span>, </span>
<span id="cb119-6"><a href="out-of-bag-error-in-random-forests.html#cb119-6" aria-hidden="true" tabindex="-1"></a>                 ipara, <span class="fu">mean</span>(rf<span class="sc">$</span>err.rate[, <span class="st">&quot;OOB&quot;</span>])))</span>
<span id="cb119-7"><a href="out-of-bag-error-in-random-forests.html#cb119-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p></p>
<p>We also use the random sampling method to evaluate the errors of the models.</p>
<p></p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="out-of-bag-error-in-random-forests.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Validation error</span></span>
<span id="cb120-2"><a href="out-of-bag-error-in-random-forests.html#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ipara <span class="cf">in</span> para.v) {</span>
<span id="cb120-3"><a href="out-of-bag-error-in-random-forests.html#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) {</span>
<span id="cb120-4"><a href="out-of-bag-error-in-random-forests.html#cb120-4" aria-hidden="true" tabindex="-1"></a>train.ix <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(data), <span class="fu">floor</span>(<span class="fu">nrow</span>(data)<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb120-5"><a href="out-of-bag-error-in-random-forests.html#cb120-5" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(DX_bl <span class="sc">~</span> ., <span class="at">nodesize =</span> ipara, </span>
<span id="cb120-6"><a href="out-of-bag-error-in-random-forests.html#cb120-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data[train.ix, </span>
<span id="cb120-7"><a href="out-of-bag-error-in-random-forests.html#cb120-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb120-8"><a href="out-of-bag-error-in-random-forests.html#cb120-8" aria-hidden="true" tabindex="-1"></a>pred.test <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, data[<span class="sc">-</span>train.ix, ], <span class="at">type =</span> <span class="st">&quot;class&quot;</span>)</span>
<span id="cb120-9"><a href="out-of-bag-error-in-random-forests.html#cb120-9" aria-hidden="true" tabindex="-1"></a>this.err <span class="ot">&lt;-</span> <span class="fu">length</span>(</span>
<span id="cb120-10"><a href="out-of-bag-error-in-random-forests.html#cb120-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">which</span>(pred.test <span class="sc">!=</span> data[<span class="sc">-</span>train.ix, ]<span class="sc">$</span>DX_bl))<span class="sc">/</span><span class="fu">length</span>(pred.test)</span>
<span id="cb120-11"><a href="out-of-bag-error-in-random-forests.html#cb120-11" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">c</span>(<span class="st">&quot;Validation_Error&quot;</span>, ipara, this.err))</span>
<span id="cb120-12"><a href="out-of-bag-error-in-random-forests.html#cb120-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb120-13"><a href="out-of-bag-error-in-random-forests.html#cb120-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p></p>
<p>Then, we obtain the training errors of the models.</p>
<p></p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="out-of-bag-error-in-random-forests.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training error</span></span>
<span id="cb121-2"><a href="out-of-bag-error-in-random-forests.html#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ipara <span class="cf">in</span> para.v) {</span>
<span id="cb121-3"><a href="out-of-bag-error-in-random-forests.html#cb121-3" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(DX_bl <span class="sc">~</span> ., <span class="at">nodesize =</span> ipara, <span class="at">data =</span> data)  </span>
<span id="cb121-4"><a href="out-of-bag-error-in-random-forests.html#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co"># nodesize = inodesize</span></span>
<span id="cb121-5"><a href="out-of-bag-error-in-random-forests.html#cb121-5" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf, data, <span class="at">type =</span> <span class="st">&quot;class&quot;</span>)</span>
<span id="cb121-6"><a href="out-of-bag-error-in-random-forests.html#cb121-6" aria-hidden="true" tabindex="-1"></a>this.err <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">which</span>(pred <span class="sc">!=</span> data<span class="sc">$</span>DX_bl))<span class="sc">/</span><span class="fu">length</span>(pred)</span>
<span id="cb121-7"><a href="out-of-bag-error-in-random-forests.html#cb121-7" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">c</span>(<span class="st">&quot;Training_Error&quot;</span>, ipara, this.err))</span>
<span id="cb121-8"><a href="out-of-bag-error-in-random-forests.html#cb121-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-9"><a href="out-of-bag-error-in-random-forests.html#cb121-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-10"><a href="out-of-bag-error-in-random-forests.html#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;type&quot;</span>, <span class="st">&quot;min_node_size&quot;</span>, <span class="st">&quot;error&quot;</span>)</span>
<span id="cb121-11"><a href="out-of-bag-error-in-random-forests.html#cb121-11" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(results)</span>
<span id="cb121-12"><a href="out-of-bag-error-in-random-forests.html#cb121-12" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>error <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(results<span class="sc">$</span>error))</span>
<span id="cb121-13"><a href="out-of-bag-error-in-random-forests.html#cb121-13" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>min_node_size <span class="ot">&lt;-</span> <span class="fu">factor</span>(results<span class="sc">$</span>min_node_size,</span>
<span id="cb121-14"><a href="out-of-bag-error-in-random-forests.html#cb121-14" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">unique</span>(results<span class="sc">$</span>min_node_size))</span>
<span id="cb121-15"><a href="out-of-bag-error-in-random-forests.html#cb121-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_boxplot</span>(<span class="at">data =</span> results,</span>
<span id="cb121-16"><a href="out-of-bag-error-in-random-forests.html#cb121-16" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">aes</span>(<span class="at">y =</span> error, <span class="at">x =</span> min_node_size,</span>
<span id="cb121-17"><a href="out-of-bag-error-in-random-forests.html#cb121-17" aria-hidden="true" tabindex="-1"></a>                            <span class="at">color =</span> type)) <span class="sc">+</span> </span>
<span id="cb121-18"><a href="out-of-bag-error-in-random-forests.html#cb121-18" aria-hidden="true" tabindex="-1"></a>           <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p></p>
<p>Figure <a href="out-of-bag-error-in-random-forests.html#fig:f5-15">87</a> shows that the OOB error rates are reasonably aligned with the testing error rates, while the training error rates are deceptively smaller.</p>
<p>The following R code conducts another numeric experiment to see if the number of trees impacts the OOB errors. In particular, we compare <span class="math inline">\(50\)</span> trees with <span class="math inline">\(500\)</span> trees, with their OOB errors plotted in Figure <a href="out-of-bag-error-in-random-forests.html#fig:f5-16">88</a>. On the other hand, we also observe that by increasing the number of trees, the OOB error decreases. This phenomenon is not universal (i.e., it is not always observed in all the datasets), but it does indicate the limitation of the OOB error: it is not as robust as the random sampling or cross-validation methods in preventing overfitting. But overall, the idea of OOB is inspiring.</p>
<p></p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="out-of-bag-error-in-random-forests.html#cb122-1" aria-hidden="true" tabindex="-1"></a>para.v <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>)</span>
<span id="cb122-2"><a href="out-of-bag-error-in-random-forests.html#cb122-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb122-3"><a href="out-of-bag-error-in-random-forests.html#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="out-of-bag-error-in-random-forests.html#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co"># OOB error with 500 trees</span></span>
<span id="cb122-5"><a href="out-of-bag-error-in-random-forests.html#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ipara <span class="cf">in</span> para.v) {</span>
<span id="cb122-6"><a href="out-of-bag-error-in-random-forests.html#cb122-6" aria-hidden="true" tabindex="-1"></a>  rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(DX_bl <span class="sc">~</span> ., <span class="at">nodesize =</span> ipara, <span class="at">ntree =</span> <span class="dv">500</span>,</span>
<span id="cb122-7"><a href="out-of-bag-error-in-random-forests.html#cb122-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> data)  </span>
<span id="cb122-8"><a href="out-of-bag-error-in-random-forests.html#cb122-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># nodesize = inodesize</span></span>
<span id="cb122-9"><a href="out-of-bag-error-in-random-forests.html#cb122-9" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">c</span>(<span class="st">&quot;OOB_Error_500trees&quot;</span>, ipara,</span>
<span id="cb122-10"><a href="out-of-bag-error-in-random-forests.html#cb122-10" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">mean</span>(rf<span class="sc">$</span>err.rate[,<span class="st">&quot;OOB&quot;</span>])))</span>
<span id="cb122-11"><a href="out-of-bag-error-in-random-forests.html#cb122-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-12"><a href="out-of-bag-error-in-random-forests.html#cb122-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-13"><a href="out-of-bag-error-in-random-forests.html#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="co"># OOB error with 50 trees</span></span>
<span id="cb122-14"><a href="out-of-bag-error-in-random-forests.html#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ipara <span class="cf">in</span> para.v) {</span>
<span id="cb122-15"><a href="out-of-bag-error-in-random-forests.html#cb122-15" aria-hidden="true" tabindex="-1"></a>  rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(DX_bl <span class="sc">~</span> ., <span class="at">nodesize =</span> ipara, <span class="at">ntree =</span> <span class="dv">50</span>,</span>
<span id="cb122-16"><a href="out-of-bag-error-in-random-forests.html#cb122-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> data)  <span class="co"># nodesize = inodesize</span></span>
<span id="cb122-17"><a href="out-of-bag-error-in-random-forests.html#cb122-17" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">c</span>(<span class="st">&quot;OOB_Error_50trees&quot;</span>, ipara,</span>
<span id="cb122-18"><a href="out-of-bag-error-in-random-forests.html#cb122-18" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">mean</span>(rf<span class="sc">$</span>err.rate[,<span class="st">&quot;OOB&quot;</span>])))</span>
<span id="cb122-19"><a href="out-of-bag-error-in-random-forests.html#cb122-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-20"><a href="out-of-bag-error-in-random-forests.html#cb122-20" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;type&quot;</span>, <span class="st">&quot;min_node_size&quot;</span>, <span class="st">&quot;error&quot;</span>)</span>
<span id="cb122-21"><a href="out-of-bag-error-in-random-forests.html#cb122-21" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(results)</span>
<span id="cb122-22"><a href="out-of-bag-error-in-random-forests.html#cb122-22" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>error <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(results<span class="sc">$</span>error))</span>
<span id="cb122-23"><a href="out-of-bag-error-in-random-forests.html#cb122-23" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>min_node_size <span class="ot">&lt;-</span> <span class="fu">factor</span>(results<span class="sc">$</span>min_node_size,</span>
<span id="cb122-24"><a href="out-of-bag-error-in-random-forests.html#cb122-24" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">unique</span>(results<span class="sc">$</span>min_node_size))</span>
<span id="cb122-25"><a href="out-of-bag-error-in-random-forests.html#cb122-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_boxplot</span>(<span class="at">data =</span> results,</span>
<span id="cb122-26"><a href="out-of-bag-error-in-random-forests.html#cb122-26" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">aes</span>(<span class="at">y =</span> error, <span class="at">x =</span> min_node_size,</span>
<span id="cb122-27"><a href="out-of-bag-error-in-random-forests.html#cb122-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fill =</span> type)) <span class="sc">+</span> </span>
<span id="cb122-28"><a href="out-of-bag-error-in-random-forests.html#cb122-28" aria-hidden="true" tabindex="-1"></a>           <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>,<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>)</span></code></pre></div>
<p></p>
<p></p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:f5-16"></span>
<img src="graphics/5_16.png" alt="OOB error rates from random forests with a different number of trees" width="250px"  />
<!--
<p class="caption marginnote">-->Figure 88: OOB error rates from random forests with a different number of trees<!--</p>-->
<!--</div>--></span>
</p>
<p></p>
</div>
</div>
<p style="text-align: center;">
<a href="cross-validation.html"><button class="btn btn-default">Previous</button></a>
<a href="remarks-3.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>

<script src="js/jquery.js"></script>
<script src="js/tablesaw-stackonly.js"></script>
<script src="js/nudge.min.js"></script>


<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
